# Система Аутентификации и Авторизации (Django REST Framework)

## Обзор проекта

Данный проект представляет собой реализацию кастомной системы **аутентификации (AuthN)** и **авторизации (AuthZ)** на базе Django REST Framework (DRF). Система не использует стандартные "коробочные" решения Django.

* **Аутентификация** реализована с использованием **JSON Web Tokens (JWT)** и библиотеки `bcrypt` для безопасного хранения паролей.
* **Авторизация** реализована по принципу **Role-Based Access Control (RBAC)** с гибкой системой правил доступа, хранящихся в базе данных.

---

## Архитектура системы разграничения прав доступа (AuthZ)

Система авторизации построена на трёх моделях, реализующих **RBAC**:

| Модель (Таблица) | Описание |
| :--- | :--- |
| **`Role`** | Определяет роли пользователей в системе (например, `admin`, `user`). |
| **`BusinessElement`** | Определяет защищаемые ресурсы (например, `products`, `orders`). |
| **`AccessRoleRule`** | Главная таблица правил. Связывает **Роль** и **Ресурс**, определяя разрешенные действия. |

### Схема ограничений доступа (`AccessRoleRule`)

Таблица `AccessRoleRule` содержит булевы поля, которые разрешают или запрещают конкретное действие для связки `Role` + `BusinessElement`.

| Поле | Действие | Описание |
| :--- | :--- | :--- |
| `read_permission` | Чтение (своих) | Разрешает чтение **своих** объектов. |
| `read_all_permission` | Чтение (всех) | Разрешает чтение **всех** объектов. |
| `create_permission` | Создание | Разрешает создание новых объектов. |
| `update_permission` | Обновление (своих) | Разрешает обновление **своих** объектов. |
| `update_all_permission` | Обновление (всех) | Разрешает обновление **всех** объектов. |
| `delete_permission` | Удаление (своих) | Разрешает удаление **своих** объектов. |
| `delete_all_permission` | Удаление (всех) | Разрешает удаление **всех** объектов. |

### Функция проверки разрешений (`check_permission`)

Проверка доступа выполняется в специальной функции `check_permission(request, element_name, action)`:
1.  Получает текущего пользователя (`request.user`) и его **Роль**.
2.  Находит соответствующее правило в таблице **`AccessRoleRule`**.
3.  Проверяет, установлен ли необходимый булев флаг для запрашиваемого действия.
4.  Возвращает `True` или `False`.

---

## Аутентификация (AuthN)

### 1. Управление пользователями

| Endpoint | Метод | Описание |
| :--- | :--- | :--- |
| `/api/register/` | `POST` | Создание нового пользователя с хэшированием пароля через `bcrypt`. |
| `/api/login/` | `POST` | Проверка пароля через `bcrypt.checkpw()` и генерация JWT-токена (срок действия 24 часа). |
| `/api/logout/` | `POST` | Выход. JWT является *stateless*, клиент просто удаляет токен. |
| `/api/profile/` | `GET`, `PUT` | Просмотр и обновление личных данных. |
| `/api/delete-account/` | `DELETE` | **Мягкое удаление** аккаунта: устанавливает поле `is_active = False` для предотвращения дальнейшей авторизации. |

### 2. Обработка JWT

Аутентификация построена на механизмах DRF:

* **Класс аутентификации:** **`JWTAuthentication`** извлекает токен из заголовка `Authorization: Bearer <token>`, декодирует его и устанавливает `request.user`.
* **Класс разрешений:** **`IsAuthenticated`** в каждой защищенной вьюхе гарантирует, что пользователь аутентифицирован.

---

## Запуск проекта

1.  **Клонирование репозитория:**
    ```bash
    git clone [https://www.nic.ru/info/blog/repository/](https://www.nic.ru/info/blog/repository/)
    cd [имя_папки]
    ```

2.  **Установка зависимостей:**
    ```bash
    pip install -r requirements.txt
    # (Предполагаются Django, djangorestframework, pyjwt, bcrypt)
    ```

3.  **Настройка БД и миграции:**
    * Проверьте настройки БД в `settings.py`.
    * Выполните миграции:
        ```bash
        python manage.py migrate
        ```

4.  **Заполнение начальными данными:**
    Используйте кастомную команду для создания тестовых ролей, ресурсов и пользователей (`admin/user` с паролем `12345`):
    ```bash
    python manage.py init_data
    ```

5.  **Запуск сервера:**
    ```bash
    python manage.py runserver
    ```

---

## Список конечных точек (API Endpoints)

| URL | Метод | Описание | Защита |
| :--- | :--- | :--- | :--- |
| `/api/register/` | `POST` | Регистрация нового пользователя. | Нет |
| `/api/login/` | `POST` | Аутентификация и выдача JWT-токена. | Нет |
| `/api/profile/` | `GET`, `PUT` | Просмотр и обновление профиля. | `IsAuthenticated` |
| `/api/delete-account/` | `DELETE` | Мягкое удаление аккаунта. | `IsAuthenticated` |
| `/api/logout/` | `POST` | Выход. | Нет |
| `/api/admin/rules/` | `GET`, `POST` | Управление правилами доступа (CRUD). | Проверка роли (admin) |
| `/api/products/` | `GET`, `POST` | Mock-ресурс: Проверка права доступа к продуктам. | `check_permission` |
